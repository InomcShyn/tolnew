(()=>{"use strict";const e={register_language:async()=>{const e="undefined"!=typeof browser?browser.declarativeNetRequest:chrome.declarativeNetRequest,t="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{await new Promise(((a,r)=>{e.updateDynamicRules({removeRuleIds:[1,2,3],addRules:[{id:1,priority:1,action:{type:"redirect",redirect:{transform:{queryTransform:{addOrReplaceParams:[{key:"lang",value:"vi"}]}}}},condition:{regexFilter:"^https://zcaptcha\\.api\\.zaloapp\\.com/",resourceTypes:["main_frame","sub_frame","xmlhttprequest"]}},{id:2,priority:1,action:{type:"redirect",redirect:{transform:{queryTransform:{addOrReplaceParams:[{key:"hl",value:"en-US"}]}}}},condition:{regexFilter:"^(http|https)://[^\\.]*\\.(google\\.com|recaptcha\\.net)/recaptcha",resourceTypes:["sub_frame"]}},{id:3,priority:1,action:{type:"modifyHeaders",requestHeaders:[{header:"Accept-Language",operation:"set",value:"en-US,en;q=0.9"}]},condition:{urlFilter:"*",resourceTypes:["main_frame","sub_frame","xmlhttprequest","script","stylesheet","image","object","ping","csp_report","media","font","websocket","webtransport","webbundle","other"]}}]},(()=>{t.lastError?r(new Error(`Error updating dynamic rules: ${t.lastError.message}`)):a()}))}))}catch(e){throw e}}},t=e,a={API_KEY:{key:"api_key",defaultValue:""},APP_ID:{key:"appId",defaultValue:""},POWER_ON:{key:"power_on",defaultValue:!0},TIKTOK:{key:"tiktok",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},FUNCAPTCHA:{key:"funcaptcha",defaultValue:{delayClick:100,loop:!0,isActive:!0,maxImageCaptcha:25}},ZALO:{key:"zalo",defaultValue:{delayClick:100,loop:!0,isActive:!0}},SHOPEE:{key:"shopee",defaultValue:{delaySwipe:15,loop:!0,isActive:!0}},RECAPTCHAV2:{key:"reCaptchav2",defaultValue:{delayClick:500,loop:!0,isActive:!0,useToken:!1}},AMZN:{key:"amzn",defaultValue:{delayClick:100,loop:!0,isActive:!0}},GEETEST:{key:"geetest",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},SLIDE_ALL:{key:"slide_all",defaultValue:{delaySwipe:15,loop:!0,isActive:!0}},HCAPTCHA:{key:"hcaptcha",defaultValue:{delayClick:500,delaySwipe:15,loop:!0,isActive:!0}},CLOUDFLARE:{key:"cloudflare",defaultValue:{delayClick:2e3,isActive:!0}}};let r=Promise.resolve();const o=async(e,t)=>{const a="undefined"!=typeof browser?browser.storage.local:chrome.storage.local,o="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{return r=r.then((()=>new Promise(((r,s)=>{a.set({[e]:t},(()=>{o.lastError?s(new Error(`Error setting ${e}: ${o.lastError.message}`)):r(!0)}))})))),await r,!0}catch(e){throw e}};async function s(e){return new Promise((t=>setTimeout(t,e)))}const i={GET_BALANCE_URL:"https://api.omocaptcha.com/v2/getBalance",CREATE_JOB_URL:"https://api.omocaptcha.com/v2/createTask",GET_RESULT_URL:"https://api.omocaptcha.com/v2/getTaskResult",REPORT_URL:"https://api.omocaptcha.com/v2/report"};t.register_language();const n=async()=>{const e="undefined"!=typeof browser?browser.runtime:chrome.runtime,t="undefined"!=typeof browser?browser.storage.local:chrome.storage.local;try{if(!(await t.get("initialized")).initialized){const t=await fetch(e.getURL("configs.json"));if(!t.ok)throw new Error(`Failed to fetch configs.json: ${t.status}`);const r=await t.json(),i={[a.API_KEY.key]:a.API_KEY.defaultValue,[a.APP_ID.key]:a.APP_ID.defaultValue,[a.POWER_ON.key]:a.POWER_ON.defaultValue,[a.TIKTOK.key]:a.TIKTOK.defaultValue,[a.FUNCAPTCHA.key]:a.FUNCAPTCHA.defaultValue,[a.ZALO.key]:a.ZALO.defaultValue,[a.SHOPEE.key]:a.SHOPEE.defaultValue,[a.RECAPTCHAV2.key]:a.RECAPTCHAV2.defaultValue,[a.AMZN.key]:a.AMZN.defaultValue,[a.GEETEST.key]:a.GEETEST.defaultValue,[a.SLIDE_ALL.key]:a.SLIDE_ALL.defaultValue,[a.HCAPTCHA.key]:a.HCAPTCHA.defaultValue,[a.CLOUDFLARE.key]:a.CLOUDFLARE.defaultValue},n=async function(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3;for(let r=1;r<=a;r++)try{return void await o(e,t)}catch(t){if(r===a)throw new Error(`Failed to set ${e}: ${t.message}`);await s(500)}};await Promise.all([...Object.entries(i).map((e=>{let[t,a]=e;return n(t,a)})),...Object.entries(r).map((e=>{let[t,a]=e;return n(t,a)})),n("initialized",!0)])}}catch(e){throw e}},c="undefined"!=typeof browser?browser.runtime:chrome.runtime,l="undefined"!=typeof browser?browser.tabs:chrome.tabs;let d,u,f;function p(e,t,a){const r=void 0!==a?{frameId:a}:{};return"undefined"!=typeof browser?browser.tabs.sendMessage(e,t,r):new Promise(((a,o)=>{chrome.tabs.sendMessage(e,t,r,(e=>{const t=chrome.runtime.lastError;if(t)return o(t);a(e)}))}))}c.onStartup.addListener((async()=>{await n()})),c.onInstalled.addListener((async()=>{await n()})),d=i.CREATE_JOB_URL,u=i.GET_RESULT_URL,f=i.REPORT_URL,c.onMessage.addListener(((e,t,r)=>{switch(e.type){case"getURL":return async function(e,t){const a="undefined"!=typeof browser?browser.tabs:chrome.tabs;if(e.tab&&e.tab.id)try{t((await a.get(e.tab.id)).url)}catch(e){t("")}else t("")}(t,r),!0;case"createTask":return async function(e,t){let r=await(async(e,t)=>{const a="undefined"!=typeof browser?browser.storage.local:chrome.storage.local,r="undefined"!=typeof browser?browser.runtime:chrome.runtime;try{const o=await a.get([e]);if(r.lastError)throw new Error(`Error retrieving ${e}: ${r.lastError.message}`);return null!=o[e]?o[e]:t}catch(e){throw e}})(a.APP_ID.key,a.APP_ID.defaultValue);const o=JSON.parse(e);o.appId=r;try{const e=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);const a=await e.json();0===Number(a.errorId)?t({taskId:a.taskId}):t({error:!0,errorCode:a.errorCode,errorDescription:a.errorDescription})}catch(e){t("")}}(e.data,r),!0;case"getTaskResult":return async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:30,a=arguments.length>2?arguments[2]:void 0;try{const r=Date.now();for(;Date.now()-r<=1e3*t;){await s(350);try{const t=await fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:e});if(!t.ok)continue;const r=await t.json();if(r.status&&("ready"===r.status||"fail"===r.status))return void a(r)}catch(e){await s(1e3)}}a("")}catch(e){a("")}}(e.data.data,e.data.timeWait,r),!0;case"reportTask":return async function(e,t){try{const a={id:e.taskIds||[],isSuccess:e.result,crxVersion:c.getManifest().version},r=await fetch(f,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!r.ok)throw new Error(`HTTP error! Status: ${r.status}`);t(await r.json())}catch(e){t("")}}(e.data,r),!0;case"createImageBase64":return async function(e,t){try{const a=await fetch(e),r=await a.blob(),o=new FileReader;o.onloadend=()=>{const e=o.result.split(",")[1];t(e)},o.onerror=()=>{t("")},o.readAsDataURL(r)}catch(e){t("")}}(e.data.url,r),!0;case"getCanvasBase64_screenshot":return async function(e,t,a){if(!e||!e.id)return void a({error:"Tab không hợp lệ."});const r=e.id;try{const o=(await p(r,{type:"getAllRectIframe"})).find((e=>e.src.includes("frame=challenge")));if(!o)return void a({error:"Không tìm thấy frame hCaptcha."});const s=await l.captureVisibleTab(e.windowId,{format:"png"}),i={left:o.rect.left+t.left,top:o.rect.top+t.top,width:t.width,height:t.height},n=await p(r,{type:"cropImage",screenshotDataUrl:s,cropConfig:i},0);if(n.error)return void a({error:n.error});a({base64:n.base64})}catch(e){a({error:`Đã xảy ra lỗi: ${e.message}`})}}(t.tab,e.data.rectCanvas,r),!0;default:return r(""),!0}}))})();